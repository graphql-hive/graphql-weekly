name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - run: bun install --frozen-lockfile

      - run: bun run lint

      - run: bun run typecheck

      - run: bun run migrate:up
        working-directory: packages/api

      - run: bunx playwright install --with-deps chromium

      - run: bun run test

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: packages/e2e/playwright-report/
          retention-days: 30

  deploy:
    needs: check
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - run: bun install --frozen-lockfile

      - name: Detect changes
        id: changes
        if: github.event_name == 'pull_request'
        # HEAD is a synthetic merge commit, HEAD^1 is base branch tip, HEAD^2 is PR branch tip
        run: |
          CHANGED=$(git diff --name-only HEAD^1 HEAD)
          echo "$CHANGED"
          echo "api=$([[ "$CHANGED" == *packages/api/* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "cms=$([[ "$CHANGED" == *packages/cms/* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "web=$([[ "$CHANGED" == *packages/web/* ]] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Set preview URL
        id: url
        if: github.event_name == 'pull_request'
        run: |
          BRANCH_SLUG=$(echo "${{ github.head_ref }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//' | cut -c1-63)
          echo "branch-slug=$BRANCH_SLUG" >> $GITHUB_OUTPUT

      - name: Build
        run: bun turbo build
        env:
          PUBLIC_API_URL: ${{ github.event_name == 'pull_request' && format('https://{0}-api.graphqlweekly.com/graphql', steps.url.outputs.branch-slug) || '' }}
          PUBLIC_AUTH_URL: ${{ github.event_name == 'pull_request' && 'https://preview-auth.graphqlweekly.com' || '' }}

      - name: Upload API Preview Version
        id: deploy-api
        working-directory: packages/api
        run: bunx wrangler versions upload --env preview --preview-alias "${{ steps.url.outputs.branch-slug }}" --message "$PR_TITLE | $(git rev-parse --short HEAD^2) | $(git log -1 --format=%s HEAD^2)"
        if: github.event_name == 'pull_request' && steps.changes.outputs.api == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PR_TITLE: ${{ github.event.pull_request.title }}

      - name: Upload CMS Preview Version
        id: deploy-cms
        working-directory: packages/cms
        run: bunx wrangler versions upload --preview-alias "${{ steps.url.outputs.branch-slug }}" --message "$PR_TITLE | $(git rev-parse --short HEAD^2) | $(git log -1 --format=%s HEAD^2)"
        if: github.event_name == 'pull_request' && steps.changes.outputs.cms == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PR_TITLE: ${{ github.event.pull_request.title }}

      - name: Upload Web Preview Version
        id: deploy-web
        working-directory: packages/web
        run: bunx wrangler versions upload --preview-alias "${{ steps.url.outputs.branch-slug }}" --message "$PR_TITLE | $(git rev-parse --short HEAD^2) | $(git log -1 --format=%s HEAD^2)"
        if: github.event_name == 'pull_request' && steps.changes.outputs.web == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PR_TITLE: ${{ github.event.pull_request.title }}

      - name: Generate PR comment
        id: comment
        if: github.event_name == 'pull_request'
        run: echo "body<<EOF" >> $GITHUB_OUTPUT && bun scripts/generate-preview-comment.ts >> $GITHUB_OUTPUT && echo "EOF" >> $GITHUB_OUTPUT
        env:
          BRANCH_SLUG: ${{ steps.url.outputs.branch-slug }}
          COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
          DEPLOYED_API: ${{ steps.deploy-api.outcome == 'success' }}
          DEPLOYED_CMS: ${{ steps.deploy-cms.outcome == 'success' }}
          DEPLOYED_WEB: ${{ steps.deploy-web.outcome == 'success' }}

      - name: Find PR comment
        uses: peter-evans/find-comment@3eae4d37986fb5a8592848f6a574fdf654e61f9e # v3.1.0
        id: find-comment
        if: github.event_name == 'pull_request' && steps.comment.outputs.body != ''
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: <!--- preview-deployment --->

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        if: github.event_name == 'pull_request' && steps.comment.outputs.body != ''
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.comment.outputs.body }}
          edit-mode: replace

      - name: Deploy preview auth worker
        working-directory: packages/api
        run: bunx wrangler deploy --env preview
        if: github.ref == 'refs/heads/main'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy API, CMS, and Web to production
        run: bun turbo deploy
        if: github.ref == 'refs/heads/main'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
